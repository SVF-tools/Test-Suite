/*
CVE-ID: CVE-2022-27239
Description: In cifs-utils through 6.14, a stack-based buffer overflow when parsing the mount.cifs ip= command-line argument could lead to local attackers gaining root privileges. 
*/

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <assert.h>

#define EX_USAGE 1
#define OPT_IP 6
#define OPT_ERROR -1
#define MAX_ADDRESS_LEN 46
#define MAX_ADDR_LIST_LEN ((MAX_ADDRESS_LEN + 1) * 16)

struct parsed_mount_info {
	char addrlist[45];
	unsigned int verboseflag:1;
};

int parse_opt_token(const char *token) {
    printf("parse opt token, token: %s\n", token);
	if (token == NULL)
		return OPT_ERROR;

	/*
	 * token is NULL terminated and contains exactly the
	 * keyword so we can match exactly
	 */
	if (strcmp(token, "ip") == 0 || strcmp(token, "addr") == 0)
		return OPT_IP;
	
	return OPT_ERROR;
}

//format is keyword,keyword2=value2,keyword3=value3...
int parse_options(const char *data, struct parsed_mount_info *parsed_info) {
	char *value = malloc(strlen(data) + 1);
	char *equals = malloc(strlen(data) + 1);
	char *next_keyword = malloc(strlen(data) + 1);

	if (!data)
		return EX_USAGE;

    char buffer[strlen(data) + 1];
    strcpy(buffer, data);
    printf("parse option, buffer:%s\n", buffer);
    char *token = strtok(buffer, ",");
    while(token != NULL) {
        strcpy(next_keyword, token);

        /* temporarily null terminate keyword if there's a value */
        value = NULL;
		if ((equals = strchr(next_keyword, '=')) != NULL) {
			*equals = '\0';
			value = equals + 1;
		}

        if(value && parse_opt_token(next_keyword) == OPT_IP) {
			if (strnlen(value, MAX_ADDRESS_LEN) <= MAX_ADDRESS_LEN) {
                //assert(strlen(value) < MAX_ADDRESS_LEN);
                //printf("value len: %lu\n", strlen(value));
				strcpy(parsed_info->addrlist, value); //potential buffer overflow
				if (parsed_info->verboseflag)
					fprintf(stderr, "ip address %s override specified\n", value);
			}
		}

        token = strtok(NULL, ",");
    }

	return 0;
}

int main() {
    struct parsed_mount_info parsed_info;
    parse_options("keyword,ip=VapodinGmVAFzAbsPWGkWdPQI2gozcQulsHW1hJRsyVlaZ,keyword3=value3", &parsed_info);
}
